<!DOCTYPE html>

<html>
<head>
  <title>core.go</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="cli.html">
                  cli.go
                </a>
              
                
                <a class="source" href="become.html">
                  become.js
                </a>
              
                
                <a class="source" href="cache.html">
                  cache.js
                </a>
              
                
                <a class="source" href="copy.html">
                  copy.js
                </a>
              
                
                <a class="source" href="dep_graph.html">
                  dep_graph.js
                </a>
              
                
                <a class="source" href="elasticache.html">
                  elasticache.js
                </a>
              
                
                <a class="source" href="elb.html">
                  elb.js
                </a>
              
                
                <a class="source" href="file.html">
                  file.js
                </a>
              
                
                <a class="source" href="git.html">
                  git.js
                </a>
              
                
                <a class="source" href="iam.html">
                  iam.js
                </a>
              
                
                <a class="source" href="instance.html">
                  instance.js
                </a>
              
                
                <a class="source" href="mithras.html">
                  mithras.js
                </a>
              
                
                <a class="source" href="network.html">
                  network.js
                </a>
              
                
                <a class="source" href="object_path.html">
                  object_path.js
                </a>
              
                
                <a class="source" href="packager.html">
                  packager.js
                </a>
              
                
                <a class="source" href="rds.html">
                  rds.js
                </a>
              
                
                <a class="source" href="route53.html">
                  route53.js
                </a>
              
                
                <a class="source" href="s3.html">
                  s3.js
                </a>
              
                
                <a class="source" href="scp.html">
                  scp.js
                </a>
              
                
                <a class="source" href="secgroup.html">
                  secgroup.js
                </a>
              
                
                <a class="source" href="service.html">
                  service.js
                </a>
              
                
                <a class="source" href="shell.html">
                  shell.js
                </a>
              
                
                <a class="source" href="sprintf.html">
                  sprintf.js
                </a>
              
                
                <a class="source" href="subnet.html">
                  subnet.js
                </a>
              
                
                <a class="source" href="traverse.html">
                  traverse.js
                </a>
              
                
                <a class="source" href="vpc.html">
                  vpc.js
                </a>
              
                
                <a class="source" href="main.html">
                  main.go
                </a>
              
                
                <a class="source" href="build.html">
                  build.go
                </a>
              
                
                <a class="source" href="channels.html">
                  channels.go
                </a>
              
                
                <a class="source" href="core.html">
                  core.go
                </a>
              
                
                <a class="source" href="elasticache.html">
                  elasticache.go
                </a>
              
                
                <a class="source" href="elb.html">
                  elb.go
                </a>
              
                
                <a class="source" href="exec.html">
                  exec.go
                </a>
              
                
                <a class="source" href="filepath.html">
                  filepath.go
                </a>
              
                
                <a class="source" href="fs.html">
                  fs.go
                </a>
              
                
                <a class="source" href="goroutines.html">
                  goroutines.go
                </a>
              
                
                <a class="source" href="iam.html">
                  iam.go
                </a>
              
                
                <a class="source" href="instance.html">
                  instance.go
                </a>
              
                
                <a class="source" href="log.html">
                  log.go
                </a>
              
                
                <a class="source" href="network.html">
                  network.go
                </a>
              
                
                <a class="source" href="os.html">
                  os.go
                </a>
              
                
                <a class="source" href="peek.html">
                  peek.go
                </a>
              
                
                <a class="source" href="rds.html">
                  rds.go
                </a>
              
                
                <a class="source" href="region.html">
                  region.go
                </a>
              
                
                <a class="source" href="remote.html">
                  remote.go
                </a>
              
                
                <a class="source" href="require.html">
                  require.go
                </a>
              
                
                <a class="source" href="route53.html">
                  route53.go
                </a>
              
                
                <a class="source" href="routetables.html">
                  routetables.go
                </a>
              
                
                <a class="source" href="s3.html">
                  s3.go
                </a>
              
                
                <a class="source" href="secgroup.html">
                  secgroup.go
                </a>
              
                
                <a class="source" href="service.html">
                  service.go
                </a>
              
                
                <a class="source" href="subnet.html">
                  subnet.go
                </a>
              
                
                <a class="source" href="tag.html">
                  tag.go
                </a>
              
                
                <a class="source" href="time.html">
                  time.go
                </a>
              
                
                <a class="source" href="user.html">
                  user.go
                </a>
              
                
                <a class="source" href="vpc.html">
                  vpc.go
                </a>
              
                
                <a class="source" href="web.html">
                  web.go
                </a>
              
                
                <a class="source" href="wrapper.html">
                  wrapper.go
                </a>
              
                
                <a class="source" href="script.html">
                  script.go
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>core.go</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">package</span> core

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>

	<span class="hljs-string">"github.com/aws/aws-sdk-go/aws"</span>
	<span class="hljs-string">"github.com/aws/aws-sdk-go/aws/session"</span>
	<span class="hljs-string">"github.com/aws/aws-sdk-go/service/ec2"</span>
	<span class="hljs-string">"github.com/robertkrimen/otto"</span>
)

<span class="hljs-keyword">var</span> InitFuncs []<span class="hljs-keyword">func</span>(*otto.Otto)
<span class="hljs-keyword">var</span> HandlerFuncs []<span class="hljs-keyword">func</span>(*otto.Otto, *otto.Value, *otto.Value) (*otto.Value, <span class="hljs-keyword">bool</span>)
<span class="hljs-keyword">var</span> PreFlightFuncs = <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">func</span>(*otto.Otto, *otto.Value, *otto.Value) (*otto.Value, <span class="hljs-keyword">bool</span>){}

<span class="hljs-keyword">func</span> RegisterInit(f <span class="hljs-keyword">func</span>(*otto.Otto)) {
	InitFuncs = <span class="hljs-built_in">append</span>(InitFuncs, f)
}

<span class="hljs-keyword">func</span> RegisterHandler(f <span class="hljs-keyword">func</span>(*otto.Otto, *otto.Value, *otto.Value) (*otto.Value, <span class="hljs-keyword">bool</span>)) {
	HandlerFuncs = <span class="hljs-built_in">append</span>(HandlerFuncs, f)
}

<span class="hljs-keyword">func</span> RegisterPreFlight(name <span class="hljs-keyword">string</span>, f <span class="hljs-keyword">func</span>(*otto.Otto, *otto.Value, *otto.Value) (*otto.Value, <span class="hljs-keyword">bool</span>)) {
	PreFlightFuncs[name] = f
}

<span class="hljs-keyword">func</span> StringsToArray(rt *otto.Otto, ary []*<span class="hljs-keyword">string</span>) *otto.Object {
	o, err := rt.Object(<span class="hljs-string">`([])`</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
	<span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> ary {
		v, err := rt.ToValue(*e)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-built_in">panic</span>(err)
		}
		o.Call(<span class="hljs-string">"push"</span>, v)
	}
	<span class="hljs-keyword">return</span> o
}

<span class="hljs-keyword">func</span> IsModule(rt *otto.Otto, resource *otto.Value, moduleName <span class="hljs-keyword">string</span>) <span class="hljs-keyword">bool</span> {
	r := *resource.Object()
	js := <span class="hljs-string">`(function () { return this["module"] || ""; })`</span>
	name, err := rt.Call(js, r)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Resource missing param 'name'."</span>)
	}
	<span class="hljs-keyword">return</span> (moduleName == name.String())
}

<span class="hljs-keyword">func</span> Module(rt *otto.Otto, resource *otto.Value) <span class="hljs-keyword">string</span> {
	r := *resource.Object()
	js := <span class="hljs-string">`(function () { return this["module"]; })`</span>
	name, err := rt.Call(js, r)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Resource missing param 'name'."</span>)
	}
	<span class="hljs-keyword">return</span> name.String()
}

<span class="hljs-keyword">func</span> IsVerbose(rt *otto.Otto) <span class="hljs-keyword">bool</span> {
	js := <span class="hljs-string">`(function () { return mithras["verbose"]; })`</span>
	v, err := rt.Call(js, <span class="hljs-literal">nil</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Mithras object is missing: %s"</span>, err)
	}
	<span class="hljs-keyword">if</span> v.IsBoolean() {
		verbose, err := v.ToBoolean()
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			log.Fatalf(<span class="hljs-string">"Mithras object error: %s"</span>, err)
		}
		<span class="hljs-keyword">return</span> verbose
	}
	log.Fatalf(<span class="hljs-string">"Mithras object error: 'verbose' is not a boolean"</span>)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}

<span class="hljs-keyword">func</span> ResourceAttr(rt *otto.Otto, resource otto.Object, key <span class="hljs-keyword">string</span>) <span class="hljs-keyword">string</span> {
	js := fmt.Sprintf(<span class="hljs-string">`(function () { return this["%s"]; })`</span>, key)
	v, err := rt.Call(js, resource)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Error reading resource attribute '%s': %s"</span>, key, err)
	}
	<span class="hljs-keyword">if</span> v.IsString() {
		<span class="hljs-keyword">return</span> v.String()
	}
	log.Fatalf(<span class="hljs-string">"Resource object error: '%s' is not a string"</span>, key)
	<span class="hljs-keyword">return</span> <span class="hljs-string">""</span>
}

<span class="hljs-keyword">func</span> ResourceParams(rt *otto.Otto, resource otto.Object) otto.Value {
	js := fmt.Sprintf(<span class="hljs-string">`(function () { return this["params"] || {}; })`</span>)
	v, err := rt.Call(js, resource)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Error reading resource attribute 'params': %s"</span>, err)
	}
	<span class="hljs-keyword">return</span> v
}

<span class="hljs-keyword">func</span> GetParams(rt *otto.Otto, params otto.Object, keys []<span class="hljs-keyword">string</span>) <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span> {
	paramMap := <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>{}
	<span class="hljs-keyword">for</span> _, key := <span class="hljs-keyword">range</span> keys {
		js := fmt.Sprintf(<span class="hljs-string">`(function () { return this["%s"] || {}; })`</span>, key)
		val, err := rt.Call(js, params)
		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; !val.IsUndefined() {
			paramMap[key] = val.String()
		}
	}
	<span class="hljs-keyword">return</span> paramMap
}

<span class="hljs-keyword">func</span> DoResourceCallback(rt *otto.Otto, c otto.Object, r otto.Object, cbName <span class="hljs-keyword">string</span>, args ...<span class="hljs-keyword">interface</span>{}) <span class="hljs-keyword">bool</span> {
	n, err := r.Get(<span class="hljs-string">"name"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Error on resource callback '%s': "</span>, cbName, err)
	}
	rName := n.String()

	m, err := r.Get(cbName)
	<span class="hljs-keyword">if</span> m.IsUndefined() {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
	}

	result, err := r.Call(cbName, args...)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Error in resource '%s', callback '%s': "</span>, rName, cbName, err)
	}
	<span class="hljs-keyword">if</span> !result.IsBoolean() {
		log.Fatalf(<span class="hljs-string">"Error in resource '%s', callback '%s': No boolean returned"</span>,
			rName,
			cbName)
	}
	ok, _ := result.ToBoolean()
	<span class="hljs-keyword">return</span> ok
}

<span class="hljs-keyword">func</span> Tag(rt *otto.Otto, tags otto.Object, id <span class="hljs-keyword">string</span>, region <span class="hljs-keyword">string</span>, verbose <span class="hljs-keyword">bool</span>) {
	svc := ec2.New(session.New(),
		aws.NewConfig().WithRegion(region).WithMaxRetries(<span class="hljs-number">5</span>))

	<span class="hljs-keyword">if</span> verbose {
		log.Printf(<span class="hljs-string">"  ### Tagging '%s'\n"</span>, id)
	}

	params := &amp;ec2.CreateTagsInput{
		Resources: []*<span class="hljs-keyword">string</span>{aws.String(id)},
		Tags:      []*ec2.Tag{},
	}

	js := <span class="hljs-string">`(function (cb) {  for (var key in this) {
	                            cb(key, this[key]);
	                         }
	                      })`</span>
	_, err := rt.Call(js,
		tags,
		<span class="hljs-keyword">func</span>(call otto.FunctionCall) otto.Value {
			t := ec2.Tag{
				Key:   aws.String(call.Argument(<span class="hljs-number">0</span>).String()),
				Value: aws.String(call.Argument(<span class="hljs-number">1</span>).String()),
			}
			params.Tags = <span class="hljs-built_in">append</span>(params.Tags, &amp;t)
			<span class="hljs-keyword">return</span> otto.FalseValue()
		})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Error obtaining tags from object."</span>)
	}

	_, err = svc.CreateTags(params)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Error tagging '%s': %s"</span>, id, err)
	}
}

<span class="hljs-keyword">func</span> InstanceToObject(rt *otto.Otto, d *ec2.Instance) *otto.Object {
	j, err := json.Marshal(*d)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Instance marshal error: %s"</span>, err)
	}
	js := <span class="hljs-string">`(function (json) { return JSON.parse(json); })`</span>
	v, err := rt.Call(js, <span class="hljs-literal">nil</span>, <span class="hljs-keyword">string</span>(j))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Json parse error: %s"</span>, err)
	}

	<span class="hljs-keyword">return</span> v.Object()
}

<span class="hljs-keyword">func</span> SSHKeypath(rt *otto.Otto, r *otto.Object, instance *ec2.Instance) <span class="hljs-keyword">string</span> {
	js := <span class="hljs-string">`(function (instance) {
                 if (this.params &amp;&amp; typeof(this.params.sshKeyPathForInstance) === 'function') {
                   return this.params.sshKeyPathForInstance(instance);
                 } else {
                   return mithras.sshKeyPathForInstance({}, instance);
                 }
               })`</span>
	val, err := rt.Call(js, r, InstanceToObject(rt, instance))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || val.IsUndefined() {
		log.Fatalf(<span class="hljs-string">"Error obtaining keypath for instance '%s': %s."</span>, instance.InstanceId, err)
	}
	<span class="hljs-keyword">return</span> val.String()
}

<span class="hljs-keyword">func</span> SSHUser(rt *otto.Otto, r *otto.Object, instance *ec2.Instance) <span class="hljs-keyword">string</span> {
	js := <span class="hljs-string">`(function (instance) {
                 if (this.params &amp;&amp; typeof(this.params.sshUserForInstance) === 'function') {
                   return this.params.sshUserForInstance(instance);
                 } else {
                   return mithras.sshUserForInstance({}, instance);
                 }
               })`</span>
	val, err := rt.Call(js, r, InstanceToObject(rt, instance))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> || val.IsUndefined() {
		log.Fatalf(<span class="hljs-string">"Error obtaining user for instance '%s': %s."</span>, instance.InstanceId, err)
	}
	<span class="hljs-keyword">return</span> val.String()
}

<span class="hljs-keyword">func</span> Sanitize(rt *otto.Otto, o <span class="hljs-keyword">interface</span>{}) otto.Value {
	j, err := json.Marshal(o)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Sanitize marhsall error:"</span>, err)
	}
	js := <span class="hljs-string">`(function (json) { return JSON.parse(json); })`</span>
	val, err := rt.Call(js, <span class="hljs-literal">nil</span>, <span class="hljs-keyword">string</span>(j))
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"Sanitize can't create object: %s"</span>, err)
	}
	<span class="hljs-keyword">return</span> val
}

<span class="hljs-keyword">func</span> Sanitizer(rt *otto.Otto) <span class="hljs-keyword">func</span>(objs ...<span class="hljs-keyword">interface</span>{}) otto.Value {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">func</span>(objs ...<span class="hljs-keyword">interface</span>{}) otto.Value {
		marshalled := []<span class="hljs-keyword">string</span>{}
		<span class="hljs-keyword">for</span> _, o := <span class="hljs-keyword">range</span> objs {
			j, err := json.Marshal(o)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				log.Fatalf(<span class="hljs-string">"Sanitizer marhsall error:"</span>, err)
			}
			marshalled = <span class="hljs-built_in">append</span>(marshalled, <span class="hljs-keyword">string</span>(j))
		}
		js := <span class="hljs-string">`(function (things) {
           var parsed = _.map(things, function(thing){ return JSON.parse(thing); });
           if (parsed.length == 1) {
             return parsed[0];
           } else {
             return parsed;
           }
          })`</span>
		val, err := rt.Call(js, <span class="hljs-literal">nil</span>, marshalled)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			log.Fatalf(<span class="hljs-string">"Sanitizer error sanitizing objects: %s"</span>, err)
		}

		<span class="hljs-keyword">return</span> val
	}
}

<span class="hljs-keyword">func</span> init() {
	RegisterInit(<span class="hljs-keyword">func</span>(rt *otto.Otto) {
		<span class="hljs-keyword">var</span> o1 *otto.Object
		<span class="hljs-keyword">var</span> mObj *otto.Object
		<span class="hljs-keyword">if</span> a, err := rt.Get(<span class="hljs-string">"mithras"</span>); err != <span class="hljs-literal">nil</span> || a.IsUndefined() {
			mObj, _ = rt.Object(<span class="hljs-string">`mithras = {}`</span>)
		} <span class="hljs-keyword">else</span> {
			mObj = a.Object()
		}

		<span class="hljs-keyword">if</span> b, err := mObj.Get(<span class="hljs-string">"modules"</span>); err != <span class="hljs-literal">nil</span> || b.IsUndefined() {
			o1, _ = rt.Object(<span class="hljs-string">`mithras.modules = {}`</span>)
		} <span class="hljs-keyword">else</span> {
			o1 = b.Object()
		}

		f := <span class="hljs-keyword">func</span>(call otto.FunctionCall) otto.Value {
			name := call.Argument(<span class="hljs-number">0</span>).String()
			cb := call.Argument(<span class="hljs-number">1</span>)
			f := <span class="hljs-keyword">func</span>(rt *otto.Otto, c *otto.Value, r *otto.Value) (*otto.Value, <span class="hljs-keyword">bool</span>) {
				js := <span class="hljs-string">`(function (f, c, r) {  return f(c, r); })`</span>
				result, err := rt.Call(js, <span class="hljs-literal">nil</span>, cb, *c, *r)
				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
					log.Fatalf(<span class="hljs-string">"Error in preflight '%s': %s"</span>, name, err)
				}

				js = <span class="hljs-string">`(function () {  return this[0]; })`</span>
				target, err := rt.Call(js, result)
				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
					log.Fatalf(<span class="hljs-string">"Error in preflight '%s': %s"</span>, name, err)
				}

				js = <span class="hljs-string">`(function () {  return this[1]; })`</span>
				v, err := rt.Call(js, result)
				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
					log.Fatalf(<span class="hljs-string">"Error in preflight '%s': %s"</span>, name, err)
				}
				handled, err := v.ToBoolean()
				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
					log.Fatalf(<span class="hljs-string">"Error in handler '%s': %s"</span>, name, err)
				}

				<span class="hljs-keyword">if</span> target.Class() != <span class="hljs-string">""</span> {
					<span class="hljs-keyword">return</span> &amp;target, handled
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, handled
				}
			}
			RegisterPreFlight(name, f)
			<span class="hljs-keyword">return</span> otto.Value{}
		}
		o1.Set(<span class="hljs-string">"preflight"</span>, f)

		f = <span class="hljs-keyword">func</span>(call otto.FunctionCall) otto.Value {
			name := call.Argument(<span class="hljs-number">0</span>).String()
			cb := call.Argument(<span class="hljs-number">1</span>)
			f := <span class="hljs-keyword">func</span>(rt *otto.Otto, c *otto.Value, r *otto.Value) (*otto.Value, <span class="hljs-keyword">bool</span>) {
				js := <span class="hljs-string">`(function (f, c, r) {  return f(c, r); })`</span>
				result, err := rt.Call(js, <span class="hljs-literal">nil</span>, cb, *c, *r)
				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
					log.Fatalf(<span class="hljs-string">"Error in handler '%s': %s"</span>, name, err)
				}

				js = <span class="hljs-string">`(function () {  return this[0]; })`</span>
				target, err := rt.Call(js, result)
				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
					log.Fatalf(<span class="hljs-string">"Error in handler '%s': %s"</span>, name, err)
				}

				js = <span class="hljs-string">`(function () {  return this[1]; })`</span>
				v, err := rt.Call(js, result)
				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
					log.Fatalf(<span class="hljs-string">"Error in handler '%s': %s"</span>, name, err)
				}
				handled, err := v.ToBoolean()
				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
					log.Fatalf(<span class="hljs-string">"Error in handler '%s': %s"</span>, name, err)
				}

				<span class="hljs-keyword">if</span> !target.IsUndefined() {
					<span class="hljs-keyword">return</span> &amp;target, handled
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, handled
				}
			}
			RegisterHandler(f)
			<span class="hljs-keyword">return</span> otto.Value{}
		}
		o1.Set(<span class="hljs-string">"handle"</span>, f)

		rt.Set(<span class="hljs-string">"sanitize"</span>, <span class="hljs-keyword">func</span>(call otto.FunctionCall) otto.Value {
			val, err := call.Argument(<span class="hljs-number">0</span>).Export()
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				log.Fatalf(<span class="hljs-string">"Sanitize export error: %s"</span>, err)
			}
			<span class="hljs-keyword">return</span> Sanitize(rt, val)
		})
	})
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
