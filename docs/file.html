<!DOCTYPE html>

<html>
<head>
  <title>file.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="cli.html">
                  cli.go
                </a>
              
                
                <a class="source" href="become.html">
                  become.js
                </a>
              
                
                <a class="source" href="cache.html">
                  cache.js
                </a>
              
                
                <a class="source" href="copy.html">
                  copy.js
                </a>
              
                
                <a class="source" href="dep_graph.html">
                  dep_graph.js
                </a>
              
                
                <a class="source" href="elasticache.html">
                  elasticache.js
                </a>
              
                
                <a class="source" href="elb.html">
                  elb.js
                </a>
              
                
                <a class="source" href="file.html">
                  file.js
                </a>
              
                
                <a class="source" href="git.html">
                  git.js
                </a>
              
                
                <a class="source" href="iam.html">
                  iam.js
                </a>
              
                
                <a class="source" href="instance.html">
                  instance.js
                </a>
              
                
                <a class="source" href="mithras.html">
                  mithras.js
                </a>
              
                
                <a class="source" href="network.html">
                  network.js
                </a>
              
                
                <a class="source" href="object_path.html">
                  object_path.js
                </a>
              
                
                <a class="source" href="packager.html">
                  packager.js
                </a>
              
                
                <a class="source" href="rds.html">
                  rds.js
                </a>
              
                
                <a class="source" href="route53.html">
                  route53.js
                </a>
              
                
                <a class="source" href="s3.html">
                  s3.js
                </a>
              
                
                <a class="source" href="scp.html">
                  scp.js
                </a>
              
                
                <a class="source" href="secgroup.html">
                  secgroup.js
                </a>
              
                
                <a class="source" href="service.html">
                  service.js
                </a>
              
                
                <a class="source" href="shell.html">
                  shell.js
                </a>
              
                
                <a class="source" href="sprintf.html">
                  sprintf.js
                </a>
              
                
                <a class="source" href="subnet.html">
                  subnet.js
                </a>
              
                
                <a class="source" href="traverse.html">
                  traverse.js
                </a>
              
                
                <a class="source" href="vpc.html">
                  vpc.js
                </a>
              
                
                <a class="source" href="main.html">
                  main.go
                </a>
              
                
                <a class="source" href="build.html">
                  build.go
                </a>
              
                
                <a class="source" href="channels.html">
                  channels.go
                </a>
              
                
                <a class="source" href="core.html">
                  core.go
                </a>
              
                
                <a class="source" href="elasticache.html">
                  elasticache.go
                </a>
              
                
                <a class="source" href="elb.html">
                  elb.go
                </a>
              
                
                <a class="source" href="exec.html">
                  exec.go
                </a>
              
                
                <a class="source" href="filepath.html">
                  filepath.go
                </a>
              
                
                <a class="source" href="fs.html">
                  fs.go
                </a>
              
                
                <a class="source" href="goroutines.html">
                  goroutines.go
                </a>
              
                
                <a class="source" href="iam.html">
                  iam.go
                </a>
              
                
                <a class="source" href="instance.html">
                  instance.go
                </a>
              
                
                <a class="source" href="log.html">
                  log.go
                </a>
              
                
                <a class="source" href="network.html">
                  network.go
                </a>
              
                
                <a class="source" href="os.html">
                  os.go
                </a>
              
                
                <a class="source" href="peek.html">
                  peek.go
                </a>
              
                
                <a class="source" href="rds.html">
                  rds.go
                </a>
              
                
                <a class="source" href="region.html">
                  region.go
                </a>
              
                
                <a class="source" href="remote.html">
                  remote.go
                </a>
              
                
                <a class="source" href="require.html">
                  require.go
                </a>
              
                
                <a class="source" href="route53.html">
                  route53.go
                </a>
              
                
                <a class="source" href="routetables.html">
                  routetables.go
                </a>
              
                
                <a class="source" href="s3.html">
                  s3.go
                </a>
              
                
                <a class="source" href="secgroup.html">
                  secgroup.go
                </a>
              
                
                <a class="source" href="service.html">
                  service.go
                </a>
              
                
                <a class="source" href="subnet.html">
                  subnet.go
                </a>
              
                
                <a class="source" href="tag.html">
                  tag.go
                </a>
              
                
                <a class="source" href="time.html">
                  time.go
                </a>
              
                
                <a class="source" href="user.html">
                  user.go
                </a>
              
                
                <a class="source" href="vpc.html">
                  vpc.go
                </a>
              
                
                <a class="source" href="web.html">
                  web.go
                </a>
              
                
                <a class="source" href="wrapper.html">
                  wrapper.go
                </a>
              
                
                <a class="source" href="script.html">
                  script.go
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>file.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">root, factory</span>)</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span>.exports === <span class="hljs-string">'object'</span>) {
	<span class="hljs-built_in">module</span>.exports = factory();
    }
})(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    
    <span class="hljs-keyword">var</span> sprintf = <span class="hljs-built_in">require</span>(<span class="hljs-string">"sprintf.js"</span>).sprintf;

    <span class="hljs-keyword">var</span> handler = {
	moduleName: <span class="hljs-string">"file"</span>
	run: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">params</span>) </span>{
	    <span class="hljs-keyword">var</span> sprintf = <span class="hljs-built_in">require</span>(<span class="hljs-string">"sprintf.js"</span>).sprintf;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>If directory, all immediate subdirectories will be
created if they do not exist. If file, the file will
NOT be created if it does not exist, see the copy or
template module if you want that behavior. If link, the
symbolic link will be created or changed. Use hard for
hardlinks. If absent, directories will be recursively
deleted, and files or symlinks will be unlinked. If
touch, an empty file will be created if the path does
not exist, while an existing file or directory will
receive updated file access and modification times
(similar to the way <code>touch</code> works from the command
line).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">var</span> ensure = params.ensure;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>name of the user that should own the file/directory, as
would be fed to chown</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">var</span> chown = params.owner;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>mode the file or directory should be. For those used to
/usr/bin/chmod remember that modes are actually octal
numbers (like 0644). Leaving off the leading zero will
likely have unexpected results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">var</span> mode = params.mode;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>path of the file to link to (applies only to
ensure=link). Will accept absolute, relative and
nonexisting paths. Relative paths are not expanded.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">var</span> src = params.src;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">var</span> dest = params.dest;

	    <span class="hljs-keyword">var</span> stat = fs.stat(dest);
	    <span class="hljs-keyword">if</span> (chown) {
		<span class="hljs-keyword">var</span> u = user.lookup(chown)[<span class="hljs-number">0</span>];
		<span class="hljs-keyword">if</span> (!u) {
		    <span class="hljs-built_in">console</span>.log(sprintf(<span class="hljs-string">"User '%s' does not exist"</span>, chown));
		    os.exit(<span class="hljs-number">1</span>);
		}
	    }
	    <span class="hljs-keyword">var</span> present = !stat.Err;

	    <span class="hljs-keyword">switch</span>(ensure) {
	    <span class="hljs-keyword">case</span> <span class="hljs-string">"directory"</span>:
		<span class="hljs-keyword">if</span> (!present) {
		    error = fs.mkdirAll(dest, mode);
		    <span class="hljs-keyword">if</span> (error) {
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Create directory error"</span>, 
				    <span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
			os.exit(<span class="hljs-number">3</span>);
		    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Check it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		    <span class="hljs-keyword">var</span> stat = fs.stat(dest);
		    <span class="hljs-keyword">if</span> (stat.Err) {
			<span class="hljs-built_in">console</span>.log(sprintf(<span class="hljs-string">"Error creating directory '%s': %s"</span>, 
					    dest,
					    <span class="hljs-built_in">JSON</span>.stringify(stat, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)));
			os.exit(<span class="hljs-number">4</span>);
		    }
		    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Created"</span>);
		    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
		}
		log(sprintf(<span class="hljs-string">"Found '%s', no action taken"</span>, dest));
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
		<span class="hljs-keyword">break</span>;
	    <span class="hljs-keyword">case</span> <span class="hljs-string">"file"</span>:
	    <span class="hljs-keyword">case</span> <span class="hljs-string">"touch"</span>:
		<span class="hljs-keyword">if</span> (present) {
		    <span class="hljs-keyword">break</span>;
		}
		result = fs.create(dest);
		f = result[<span class="hljs-number">0</span>];
		error = result[<span class="hljs-number">1</span>];
		<span class="hljs-keyword">if</span> (error) {
		    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Create file error"</span>, 
				<span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
		    os.exit(<span class="hljs-number">3</span>);
		}
		error = fs.close(f);
		<span class="hljs-keyword">if</span> (error) {
		    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Create file close error"</span>, 
				<span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
		    os.exit(<span class="hljs-number">3</span>);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Check it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> stat = fs.stat(dest);
		<span class="hljs-keyword">if</span> (stat.Err) {
		    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Create file error"</span>, <span class="hljs-built_in">JSON</span>.stringify(stat, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
		    os.exit(<span class="hljs-number">4</span>);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Chown it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (chown) {
		    result = user.lookup(chown);
		    user = result[<span class="hljs-number">0</span>];
		    error = result[<span class="hljs-number">1</span>];
		    <span class="hljs-keyword">if</span> (error) {
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Copy error user lookupg"</span>, 
				    <span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
			os.exit(<span class="hljs-number">5</span>);
		    }
		    error = fs.chown(dest, user.Uid);
		    <span class="hljs-keyword">if</span> (error) {
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Copy error chown"</span>, 
				    <span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
			os.exit(<span class="hljs-number">5</span>);
		    }
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Chmod it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (mode) {
		    error = user.chown(dest, u.Uid);
		    <span class="hljs-keyword">if</span> (error) {
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Create file error"</span>, <span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
			os.exit(<span class="hljs-number">6</span>);
		    }
		}

		<span class="hljs-keyword">if</span> (ensure === <span class="hljs-string">"touch"</span>) {
		    error = user.chtimes(dest)
		    <span class="hljs-keyword">if</span> (error) {
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Create chtimes error"</span>, 
				    <span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
			os.exit(<span class="hljs-number">7</span>);
		    }
		}

		<span class="hljs-built_in">console</span>.log(sprintf(<span class="hljs-string">"Created '%s'"</span>, dest));
		<span class="hljs-keyword">break</span>;
	    <span class="hljs-keyword">case</span> <span class="hljs-string">"link"</span>:
		error = fs.symlink(src, dest);
		<span class="hljs-keyword">if</span> (error) {
		    <span class="hljs-keyword">if</span> (error.Err == <span class="hljs-number">17</span>) {
			<span class="hljs-built_in">console</span>.log(sprintf(<span class="hljs-string">"%s already exists"</span>, dest));
		    } <span class="hljs-keyword">else</span> {
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Create symlink error"</span>, <span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
			os.exit(<span class="hljs-number">8</span>);
		    }
		} <span class="hljs-keyword">else</span> {
		    <span class="hljs-built_in">console</span>.log(sprintf(<span class="hljs-string">"Created '%s'"</span>, dest));
		}
		<span class="hljs-keyword">break</span>;
	    <span class="hljs-keyword">case</span> <span class="hljs-string">"hard"</span>:
		error = fs.link(dest, src);
		<span class="hljs-keyword">if</span> (error) {
		    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Create hard link error"</span>, 
				<span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
		    os.exit(<span class="hljs-number">9</span>);
		}
		<span class="hljs-keyword">break</span>;
	    <span class="hljs-keyword">case</span> <span class="hljs-string">"absent"</span>:
		error = sanitize(fs.removeAll(dest));
		<span class="hljs-keyword">if</span> (error) {
		    <span class="hljs-built_in">console</span>.log(sprintf(<span class="hljs-string">"Can't remove '%s'"</span>, dest),
				<span class="hljs-built_in">JSON</span>.stringify(error, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
		    os.exit(<span class="hljs-number">10</span>);
		}
		<span class="hljs-keyword">break</span>;
	    <span class="hljs-keyword">default</span>:
		<span class="hljs-built_in">console</span>.log(sprintf(<span class="hljs-string">"Invalid 'ensure': %s"</span>, ensure))
		os.exit(<span class="hljs-number">11</span>);
	    }
	}
	handle: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">catalog, resources, resource</span>) </span>{
	    <span class="hljs-keyword">if</span> (resource.module != handler.moduleName) {
		<span class="hljs-keyword">return</span> [<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>];
	    }
	    <span class="hljs-keyword">var</span> params = resource.params;
	    <span class="hljs-keyword">if</span> (params.hosts) {
		<span class="hljs-keyword">var</span> js = sprintf(<span class="hljs-string">"var run = function() {\n (%s)(%s); };\n"</span>, 
				 handler.run.toString(),
				 <span class="hljs-built_in">JSON</span>.stringify(_.omit(params, <span class="hljs-string">'hosts'</span>)));
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> resource.params.hosts) {
		    <span class="hljs-keyword">var</span> instance = resource.params.hosts[i];
		    <span class="hljs-keyword">var</span> result = mithras.remote.mithras(instance, 
							mithras.sshUserForInstance(resource, 
										   instance), 
							mithras.sshKeyPathForInstance(resource, 
										      instance), 
							js,
							resource.params.become,
							resource.params.becomeUser,
							resource.params.becomeMethod);
		    <span class="hljs-keyword">if</span> (result[<span class="hljs-number">3</span>] == <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">var</span> out = result[<span class="hljs-number">0</span>].trim();
			log(sprintf(<span class="hljs-string">"File '%s' %s: %s."</span>, 
				    resource.params.dest,
				    resource.params.ensure,
				    out != <span class="hljs-string">""</span> ? out : <span class="hljs-string">"success"</span>));
		    }
		}
	    } <span class="hljs-keyword">else</span> {
		handler.run(params);
	    }
	    <span class="hljs-keyword">return</span> [<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>];
	}
    };
    
    handler.init = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
	mithras.modules.handlers.register(<span class="hljs-string">"file"</span>, handler.handle);
    };
    
    <span class="hljs-keyword">return</span> handler;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
