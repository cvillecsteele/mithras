<!DOCTYPE html>

<html>
<head>
  <title>dep_graph.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>dep_graph.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="cli.html">
                    cli.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="become.html">
                    become.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="cache.html">
                    cache.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="copy.html">
                    copy.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="dep_graph.html">
                    dep_graph.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="elasticache.html">
                    elasticache.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="elb.html">
                    elb.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="file.html">
                    file.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="git.html">
                    git.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="iam.html">
                    iam.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="instance.html">
                    instance.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="log.html">
                    log.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="mithras.html">
                    mithras.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="network.html">
                    network.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="object_path.html">
                    object_path.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="packager.html">
                    packager.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="rds.html">
                    rds.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="route53.html">
                    route53.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="s3.html">
                    s3.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="scp.html">
                    scp.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="secgroup.html">
                    secgroup.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="service.html">
                    service.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="shell.html">
                    shell.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="sprintf.html">
                    sprintf.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="subnet.html">
                    subnet.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="traverse.html">
                    traverse.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="vpc.html">
                    vpc.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="main.html">
                    main.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="build.html">
                    build.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="channels.html">
                    channels.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="core.html">
                    core.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="elasticache.html">
                    elasticache.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="elb.html">
                    elb.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="exec.html">
                    exec.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="filepath.html">
                    filepath.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="fs.html">
                    fs.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="goroutines.html">
                    goroutines.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="iam.html">
                    iam.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="instance.html">
                    instance.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="log.html">
                    log.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="network.html">
                    network.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="os.html">
                    os.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="peek.html">
                    peek.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="rds.html">
                    rds.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="region.html">
                    region.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="remote.html">
                    remote.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="require.html">
                    require.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="route53.html">
                    route53.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="routetables.html">
                    routetables.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="s3.html">
                    s3.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="secgroup.html">
                    secgroup.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="service.html">
                    service.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="subnet.html">
                    subnet.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="tag.html">
                    tag.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="time.html">
                    time.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="user.html">
                    user.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="vpc.html">
                    vpc.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="web.html">
                    web.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="wrapper.html">
                    wrapper.go
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="script.html">
                    script.go
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <p>Copyright (C) 2013-2015 by Jim Riecken</p>

        
      
        
        <p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the “Software”), to deal
    in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>

        
      
        
        <p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>

        
      
        
        <p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>

        
          <div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">window</span>) </span>{
<span class="hljs-meta">    'use strict'</span>

    <span class="hljs-comment">/**
     * A simple dependency graph
     */</span>

    <span class="hljs-comment">/**
     * Helper for creating a Depth-First-Search on
     * a set of edges.
     *
     * Detects cycles and throws an Error if one is detected.
     *
     * @param edges The set of edges to DFS through
     * @param leavesOnly Whether to only return "leaf" nodes (ones who have no edges)
     * @param result An array in which the results will be populated
     */</span>
    <span class="hljs-keyword">var</span> createDFS = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">edges, leavesOnly, result</span>) </span>{
	<span class="hljs-keyword">var</span> currentPath = [];
	<span class="hljs-keyword">var</span> visited = {};
	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DFS</span>(<span class="hljs-params">currentNode</span>) </span>{
	    visited[currentNode] = <span class="hljs-literal">true</span>;
	    currentPath.push(currentNode);
	    edges[currentNode].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
		<span class="hljs-keyword">if</span> (!visited[node]) {
		    DFS(node);
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentPath.indexOf(node) &gt;= <span class="hljs-number">0</span>) {
		    currentPath.push(node);
		    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Dependency Cycle Found: '</span> + currentPath.join(<span class="hljs-string">' -&gt; '</span>));
		}
	    });
	    currentPath.pop();
	    <span class="hljs-keyword">if</span> ((!leavesOnly || edges[currentNode].length === <span class="hljs-number">0</span>) &amp;&amp; result.indexOf(currentNode) === <span class="hljs-number">-1</span>) {
		result.push(currentNode);
	    }
	};
    }

    <span class="hljs-comment">/**
     * Simple Dependency Graph
     */</span>
    <span class="hljs-keyword">var</span> DepGraph = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DepGraph</span>(<span class="hljs-params"></span>) </span>{
	<span class="hljs-keyword">this</span>.nodes = {};
	<span class="hljs-keyword">this</span>.outgoingEdges = {}; <span class="hljs-comment">// Node -&gt; [Dependency Node]</span>
	<span class="hljs-keyword">this</span>.incomingEdges = {}; <span class="hljs-comment">// Node -&gt; [Dependant Node]</span>
    };

    DepGraph.prototype = {
	<span class="hljs-comment">/**
	 * Add a node to the dependency graph. If a node already exists, this method will do nothing.
	 */</span>
	addNode:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
	    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasNode(node)) {
		<span class="hljs-keyword">this</span>.nodes[node] = node;
		<span class="hljs-keyword">this</span>.outgoingEdges[node] = [];
		<span class="hljs-keyword">this</span>.incomingEdges[node] = [];
	    }
	},
	<span class="hljs-comment">/**
	 * Remove a node from the dependency graph. If a node does not exist, this method will do nothing.
	 */</span>
	removeNode:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
	    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasNode(node)) {
		<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.nodes[node];
		<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.outgoingEdges[node];
		<span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.incomingEdges[node];
		[<span class="hljs-keyword">this</span>.incomingEdges, <span class="hljs-keyword">this</span>.outgoingEdges].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">edgeList</span>) </span>{
		    <span class="hljs-built_in">Object</span>.keys(edgeList).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{
			<span class="hljs-keyword">var</span> idx = edgeList[key].indexOf(node);
			<span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) {
			    edgeList[key].splice(idx, <span class="hljs-number">1</span>);
			}
		    }, <span class="hljs-keyword">this</span>);
		});
	    }
	},
	<span class="hljs-comment">/**
	 * Check if a node exists in the graph
	 */</span>
	hasNode:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
	    <span class="hljs-keyword">return</span> !!<span class="hljs-keyword">this</span>.nodes[node];
	},
	<span class="hljs-comment">/**
	 * Add a dependency between two nodes. If either of the nodes does not exist,
	 * an Error will be thrown.
	 */</span>
	addDependency:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">from, to</span>) </span>{
	    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasNode(<span class="hljs-keyword">from</span>)) {
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Node does not exist: '</span> + <span class="hljs-keyword">from</span>);
	    }
	    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasNode(to)) {
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Node does not exist: '</span> + to);
	    }
	    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.outgoingEdges[<span class="hljs-keyword">from</span>].indexOf(to) === <span class="hljs-number">-1</span>) {
		<span class="hljs-keyword">this</span>.outgoingEdges[<span class="hljs-keyword">from</span>].push(to);
	    }
	    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.incomingEdges[to].indexOf(<span class="hljs-keyword">from</span>) === <span class="hljs-number">-1</span>) {
		<span class="hljs-keyword">this</span>.incomingEdges[to].push(<span class="hljs-keyword">from</span>);
	    }
	    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	},
	<span class="hljs-comment">/**
	 * Remove a dependency between two nodes.
	 */</span>
	removeDependency:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">from, to</span>) </span>{
	    <span class="hljs-keyword">var</span> idx;
	    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasNode(<span class="hljs-keyword">from</span>)) {
		idx = <span class="hljs-keyword">this</span>.outgoingEdges[<span class="hljs-keyword">from</span>].indexOf(to);
		<span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) {
		    <span class="hljs-keyword">this</span>.outgoingEdges[<span class="hljs-keyword">from</span>].splice(idx, <span class="hljs-number">1</span>);
		}
	    }

	    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasNode(to)) {
		idx = <span class="hljs-keyword">this</span>.incomingEdges[to].indexOf(<span class="hljs-keyword">from</span>);
		<span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) {
		    <span class="hljs-keyword">this</span>.incomingEdges[to].splice(idx, <span class="hljs-number">1</span>);
		}
	    }
	},
	<span class="hljs-comment">/**
	 * Get an array containing the nodes that the specified node depends on (transitively).
	 *
	 * Throws an Error if the graph has a cycle, or the specified node does not exist.
	 *
	 * If `leavesOnly` is true, only nodes that do not depend on any other nodes will be returned
	 * in the array.
	 */</span>
	dependenciesOf:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node, leavesOnly</span>) </span>{
	    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasNode(node)) {
		<span class="hljs-keyword">var</span> result = [];
		<span class="hljs-keyword">var</span> DFS = createDFS(<span class="hljs-keyword">this</span>.outgoingEdges, leavesOnly, result);
		DFS(node);
		<span class="hljs-keyword">var</span> idx = result.indexOf(node);
		<span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) {
		    result.splice(idx, <span class="hljs-number">1</span>);
		}
		<span class="hljs-keyword">return</span> result;
	    }
	    <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Node does not exist: '</span> + node);
	    }
	},
	<span class="hljs-comment">/**
	 * get an array containing the nodes that depend on the specified node (transitively).
	 *
	 * Throws an Error if the graph has a cycle, or the specified node does not exist.
	 *
	 * If `leavesOnly` is true, only nodes that do not have any dependants will be returned in the array.
	 */</span>
	dependantsOf:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node, leavesOnly</span>) </span>{
	    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasNode(node)) {
		<span class="hljs-keyword">var</span> result = [];
		<span class="hljs-keyword">var</span> DFS = createDFS(<span class="hljs-keyword">this</span>.incomingEdges, leavesOnly, result);
		DFS(node);
		<span class="hljs-keyword">var</span> idx = result.indexOf(node);
		<span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) {
		    result.splice(idx, <span class="hljs-number">1</span>);
		}
		<span class="hljs-keyword">return</span> result;
	    } <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Node does not exist: '</span> + node);
	    }
	},
	<span class="hljs-comment">/**
	 * Construct the overall processing order for the dependency graph.
	 *
	 * Throws an Error if the graph has a cycle.
	 *
	 * If `leavesOnly` is true, only nodes that do not depend on any other nodes will be returned.
	 */</span>
	overallOrder:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">leavesOnly</span>) </span>{
	    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
	    <span class="hljs-keyword">var</span> result = [];
	    <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.nodes);
	    <span class="hljs-keyword">if</span> (keys.length === <span class="hljs-number">0</span>) {
		<span class="hljs-keyword">return</span> result; <span class="hljs-comment">// Empty graph</span>
	    } <span class="hljs-keyword">else</span> {</pre></div>
        
      
        
        <p>Look for cycles - we run the DFS starting at all the nodes in case there
are several disconnected subgraphs inside this dependency graph.</p>

        
          <div class='highlight'><pre>		<span class="hljs-keyword">var</span> CycleDFS = createDFS(<span class="hljs-keyword">this</span>.outgoingEdges, <span class="hljs-literal">false</span>, []);
		keys.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) </span>{
		    CycleDFS(n);
		});

		<span class="hljs-keyword">var</span> DFS = createDFS(<span class="hljs-keyword">this</span>.outgoingEdges, leavesOnly, result);</pre></div>
        
      
        
        <p>Find all potential starting points (nodes with nothing depending on them) an
run a DFS starting at these points to get the order</p>

        
          <div class='highlight'><pre>		keys.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
		    <span class="hljs-keyword">return</span> self.incomingEdges[node].length === <span class="hljs-number">0</span>;
		}).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">n</span>) </span>{
		    DFS(n);
		});

		<span class="hljs-keyword">return</span> result;
	    }
	},

    };</pre></div>
        
      
        
        <p>export</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> exports !== <span class="hljs-string">'undefined'</span>) {
	exports.DepGraph = DepGraph;
    }
})(<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> === <span class="hljs-string">'undefined'</span> ? <span class="hljs-keyword">this</span> : <span class="hljs-built_in">window</span>);</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
